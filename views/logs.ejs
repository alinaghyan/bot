<%- include('partials/header', { title: 'لاگ سیستم' }) %>

<%- include('partials/topbar', { activePage: 'logs', user: user, aiHeaderStatus: aiHeaderStatus }) %>
<nav class="navbar navbar-expand-lg navbar-glass sticky-top">
    <div class="container">
        <a class="navbar-brand" href="/">
            <i class="fas fa-layer-group me-2"></i> ربات پایشگر
        </a>
        <div class="d-flex align-items-center gap-2">
            <a href="/" class="btn btn-glass btn-sm text-white"><i class="fas fa-home me-1"></i> صفحه اصلی</a>
            <a href="/networks" class="btn btn-glass btn-sm text-white"><i class="fas fa-sitemap me-1"></i> شبکه‌ها</a>
        </div>
        <div class="d-flex align-items-center">
            <span class="text-white me-3 d-none d-md-block">کاربر: <%= user %></span>
            <a href="/logout" class="btn btn-glass btn-sm"><i class="fas fa-sign-out-alt me-1"></i> خروج</a>
        </div>
    </div>
</nav>

<div class="container py-4">
    <div class="glass-card">
        <div class="card-header border-0 bg-transparent d-flex justify-content-between align-items-center">
            <h3 class="text-white mb-0"><i class="fas fa-bug me-2"></i> لاگ سیستم</h3>
            <div class="d-flex gap-2">
                <a href="/logs" class="btn btn-sm btn-glass text-info">
                    <i class="fas fa-sync me-1"></i> بروزرسانی
                </a>
                <button class="btn btn-sm btn-glass text-danger" onclick="clearLogs()">
                    <i class="fas fa-trash me-1"></i> پاک کردن
                </button>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-glass align-middle mb-0">
                    <thead>
                        <tr>
                            <th style="width: 170px;">زمان</th>
                            <th style="width: 80px;">سطح</th>
                            <th>پیام</th>
                            <th>جزئیات</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% if (!entries || entries.length === 0) { %>
                            <tr>
                                <td colspan="4" class="text-center py-5 text-white-50">لاگی ثبت نشده است</td>
                            </tr>
                        <% } %>
                        <% (entries || []).forEach(e => { %>
                            <tr>
                                <td dir="ltr" class="small text-white-50"><%= e.ts ? new Date(e.ts).toLocaleString('fa-IR') : '-' %></td>
                                <td>
                                    <span class="badge bg-<%= e.level === 'error' ? 'danger' : (e.level === 'warn' ? 'warning' : 'info') %> bg-opacity-75">
                                        <%= e.level %>
                                    </span>
                                </td>
                                <td><%= e.message %></td>
                                <td style="max-width: 520px;">
                                    <details>
                                        <summary class="text-white-50 small">نمایش</summary>
                                        <pre class="small text-white-50 mb-0" style="white-space: pre-wrap;"><%= JSON.stringify(e.meta || {}, null, 2) %></pre>
                                    </details>
                                </td>
                            </tr>
                        <% }) %>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="card-footer border-0 bg-transparent text-white-50 small d-flex justify-content-between">
            <div>فایل: <span dir="ltr"><%= logFile %></span></div>
            <div>نمایش: <%= entries ? entries.length : 0 %></div>
        </div>
    </div>
</div>

<script>
    async function clearLogs() {
        if (!confirm('لاگ‌ها پاک شوند؟')) return;
        try {
            const res = await fetch('/api/logs/clear', { method: 'POST' });
            const data = await res.json();
            if (!data.success) return alert(data.message || 'خطا');
            window.location.reload();
        } catch (e) {
            alert('خطا در ارتباط با سرور');
        }
    }
</script>

<%- include('partials/footer') %>
